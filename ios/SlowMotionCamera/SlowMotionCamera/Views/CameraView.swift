//
//  CameraView.swift
//  SlowMotionCamera
//
//  ë©”ì¸ ë…¹í™” í™”ë©´
//

import SwiftUI
import AVFoundation

class CameraViewController: ObservableObject {

    // MARK: - Properties

    @Published var settings: CameraSettings
    @Published var state: RecordingStateManager

    private let cameraManager = CameraManager()
    private let webSocketManager = WebSocketManager()
    private var streamingManager: StreamingManager?
    private let uploadManager = UploadManager()

    private var recordingTimer: Timer?

    // MARK: - Initialization

    init(settings: CameraSettings, state: RecordingStateManager) {
        self.settings = settings
        self.state = state

        self.streamingManager = StreamingManager(webSocketManager: webSocketManager, settings: settings)

        setupManagers()
    }

    // MARK: - Setup

    private func setupManagers() {
        cameraManager.delegate = self
        webSocketManager.delegate = self
    }

    // MARK: - Public Methods

    func connect() {
        state.setState(.connecting)
        webSocketManager.connect(to: settings.serverURL)
    }

    func disconnect() {
        stopRecording()
        webSocketManager.disconnect()
        cameraManager.stopSession()
        state.setState(.idle)
    }

    func setupCamera() {
        do {
            try cameraManager.setupCamera(
                fps: settings.recordingFPS,
                resolution: settings.recordingResolution
            )
            cameraManager.startSession()
        } catch {
            print("âŒ Camera setup error: \(error)")
            state.setState(.error, error: error.localizedDescription)
        }
    }

    func getPreviewLayer() -> AVCaptureVideoPreviewLayer {
        return cameraManager.getPreviewLayer()
    }

    // MARK: - Recording Control

    private func startRecording() {
        guard !state.isRecording else { return }

        // ë””ìŠ¤í¬ ê³µê°„ í™•ì¸
        guard cameraManager.checkDiskSpace() else {
            state.setState(.error, error: "ë””ìŠ¤í¬ ê³µê°„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.")
            return
        }

        do {
            try cameraManager.startRecording()
            streamingManager?.resetFrameCounter()
            state.setState(.recording)
            state.resetRecordingStats()

            // íƒ€ì´ë¨¸ ì‹œì‘ (ë…¹í™” ì‹œê°„ ì—…ë°ì´íŠ¸)
            startRecordingTimer()

            // ì„œë²„ì— ìƒíƒœ ì „ì†¡
            webSocketManager.sendStatus("recording")
        } catch {
            print("âŒ Failed to start recording: \(error)")
            state.setState(.error, error: error.localizedDescription)
        }
    }

    private func stopRecording() {
        guard state.isRecording else { return }

        cameraManager.stopRecording()
        stopRecordingTimer()
    }

    // MARK: - Recording Timer

    private func startRecordingTimer() {
        recordingTimer?.invalidate()
        recordingTimer = Timer.scheduledTimer(withTimeInterval: 0.1, repeats: true) { [weak self] _ in
            guard let self = self else { return }
            self.state.updateRecordingStats(
                duration: self.state.recordingDuration + 0.1,
                frames: self.state.frameCount
            )
        }
    }

    private func stopRecordingTimer() {
        recordingTimer?.invalidate()
        recordingTimer = nil
    }

    // MARK: - Upload

    private func uploadVideo(fileURL: URL) {
        state.setState(.uploading)
        webSocketManager.sendStatus("uploading")

        let uploadURL = settings.autoGeneratedUploadURL

        uploadManager.uploadWithRetry(
            fileURL: fileURL,
            to: uploadURL,
            progress: { [weak self] progress in
                self?.state.updateUploadProgress(progress)
            },
            completion: { [weak self] success, error in
                guard let self = self else { return }

                if success {
                    print("âœ… Upload completed")

                    // ì—…ë¡œë“œ ì„±ê³µ í›„ íŒŒì¼ ì‚­ì œ (ì˜µì…˜)
                    try? FileManager.default.removeItem(at: fileURL)

                    // ëŒ€ê¸° ìƒíƒœë¡œ ë³µê·€
                    self.state.setState(.waiting)
                    self.webSocketManager.sendStatus("waiting")
                } else {
                    print("âŒ Upload failed: \(error?.localizedDescription ?? "Unknown error")")
                    self.state.setState(.error, error: "ì—…ë¡œë“œ ì‹¤íŒ¨: \(error?.localizedDescription ?? "")")
                }
            }
        )
    }
}

// MARK: - CameraManagerDelegate

extension CameraViewController: CameraManagerDelegate {

    func cameraDidStartRecording() {
        print("ğŸ“¹ Recording started")
    }

    func cameraDidStopRecording(fileURL: URL) {
        print("ğŸ“¹ Recording stopped: \(fileURL.lastPathComponent)")

        // ìë™ ì—…ë¡œë“œ
        uploadVideo(fileURL: fileURL)
    }

    func cameraDidCaptureFrame(_ sampleBuffer: CMSampleBuffer) {
        // ìŠ¤íŠ¸ë¦¬ë° ì²˜ë¦¬
        if state.isRecording {
            streamingManager?.processFrame(sampleBuffer, recordingFPS: settings.recordingFPS)

            // í”„ë ˆì„ ì¹´ìš´íŠ¸ ì¦ê°€
            DispatchQueue.main.async {
                self.state.frameCount += 1
            }
        }
    }

    func cameraDidEncounterError(_ error: Error) {
        state.setState(.error, error: error.localizedDescription)
    }
}

// MARK: - WebSocketManagerDelegate

extension CameraViewController: WebSocketManagerDelegate {

    func webSocketDidConnect() {
        print("âœ… WebSocket connected")
        state.setState(.waiting)
        state.resetReconnectAttempts()
    }

    func webSocketDidDisconnect(error: Error?) {
        print("âš ï¸ WebSocket disconnected")

        if let error = error {
            state.setState(.error, error: error.localizedDescription)
        } else {
            state.setState(.connecting)
        }

        state.incrementReconnectAttempt()
    }

    func webSocketDidReceiveCommand(_ command: String) {
        print("ğŸ“© Received command: \(command)")

        switch command {
        case "start":
            startRecording()

        case "stop":
            stopRecording()

        default:
            print("âš ï¸ Unknown command: \(command)")
        }
    }
}

// MARK: - SwiftUI View

struct CameraView: View {

    @StateObject var controller: CameraViewController
    @State private var showSettings = false

    var body: some View {
        ZStack {
            // ì¹´ë©”ë¼ í”„ë¦¬ë·°
            CameraPreviewView(previewLayer: controller.getPreviewLayer())
                .edgesIgnoringSafeArea(.all)

            // ì˜¤ë²„ë ˆì´ UI
            VStack {
                // ìƒë‹¨ ë°”
                HStack {
                    Button(action: {
                        showSettings = true
                    }) {
                        HStack {
                            Image(systemName: "chevron.left")
                            Text("ì„¤ì •")
                        }
                        .foregroundColor(.white)
                        .padding(12)
                        .background(Color.black.opacity(0.5))
                        .cornerRadius(8)
                    }
                    .padding()

                    Spacer()
                }

                Spacer()

                // í•˜ë‹¨ ìƒíƒœ ì •ë³´
                VStack(spacing: 12) {
                    // ìƒíƒœ í‘œì‹œ
                    HStack {
                        Text(controller.state.statusDisplayText)
                            .font(.headline)
                            .foregroundColor(.white)

                        if controller.state.isRecording {
                            Circle()
                                .fill(Color.red)
                                .frame(width: 8, height: 8)
                                .opacity(0.8)
                        }
                    }
                    .padding(.horizontal, 20)
                    .padding(.vertical, 12)
                    .background(Color.black.opacity(0.7))
                    .cornerRadius(25)

                    // ì—°ê²° ì •ë³´
                    VStack(spacing: 4) {
                        if controller.state.isConnected {
                            Text("ì—°ê²°: \(controller.settings.serverURL)")
                                .font(.caption)
                                .lineLimit(1)
                        }

                        Text("ë…¹í™”: \(controller.settings.recordingFPS)fps @ \(controller.settings.recordingResolutionName)")
                            .font(.caption)

                        Text("ìŠ¤íŠ¸ë¦¬ë°: \(controller.settings.streamingFPS)fps @ \(controller.settings.streamingResolutionName)")
                            .font(.caption)

                        if controller.state.isRecording {
                            Text("í”„ë ˆì„: \(controller.state.frameCount)")
                                .font(.caption)
                        }
                    }
                    .foregroundColor(.white.opacity(0.8))
                    .padding(.horizontal, 20)
                    .padding(.vertical, 12)
                    .background(Color.black.opacity(0.5))
                    .cornerRadius(12)

                    // ì—ëŸ¬ ë©”ì‹œì§€
                    if let errorMessage = controller.state.errorMessage {
                        Text(errorMessage)
                            .font(.caption)
                            .foregroundColor(.red)
                            .padding(.horizontal, 20)
                            .padding(.vertical, 8)
                            .background(Color.black.opacity(0.7))
                            .cornerRadius(8)
                    }
                }
                .padding(.bottom, 40)
            }
        }
        .onAppear {
            controller.setupCamera()
            controller.connect()
        }
        .onDisappear {
            controller.disconnect()
        }
        .sheet(isPresented: $showSettings) {
            SettingsView(
                settings: controller.settings,
                isPresented: $showSettings,
                onConnect: {
                    showSettings = false
                    controller.disconnect()
                    controller.connect()
                }
            )
        }
    }
}
